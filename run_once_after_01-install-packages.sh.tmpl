#!/bin/bash
# chezmoi run_once_after: Install all packages for this profile.
# Runs once after chezmoi apply (files are already in place).
set -euo pipefail

PKGDIR="$HOME/.config/packages"
SCRIPT="$HOME/.config/scripts/install_pkgs.sh"

if [[ ! -d "$PKGDIR" ]]; then
  echo "ERROR: Package directory $PKGDIR not found."
  exit 1
fi

if [[ ! -x "$SCRIPT" ]]; then
  echo "ERROR: Install script $SCRIPT not found or not executable."
  exit 1
fi

# Ensure sudo is available and cached
if ! command -v sudo &>/dev/null; then
  echo "ERROR: sudo not found. Cannot install packages."
  exit 1
fi
echo "Caching sudo credentials..."
sudo -v

# Ensure yay is installed (needed for AUR packages)
if ! command -v yay &>/dev/null; then
  echo "Installing yay..."
  sudo pacman -S --noconfirm --needed yay
fi

# Build the list of package files for this profile
LISTS=("$PKGDIR/core.txt" "$PKGDIR/dev.txt" "$PKGDIR/apps.txt")

{{ if eq .profile "desktop" -}}
LISTS+=("$PKGDIR/desktop.txt" "$PKGDIR/gaming.txt")
{{ end -}}
{{ if or (eq .purpose "work") (eq .purpose "both") -}}
LISTS+=("$PKGDIR/work.txt")
{{ end -}}

echo ""
echo "======================================"
echo " Package Installation"
echo " profile={{ .profile }}  purpose={{ .purpose }}"
echo "======================================"
echo "Lists: ${LISTS[*]}"
echo ""

"$SCRIPT" "${LISTS[@]}"
