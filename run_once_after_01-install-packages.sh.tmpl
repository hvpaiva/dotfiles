#!/bin/bash
# chezmoi run_once_before: Install packages based on profile
set -euo pipefail

PKGDIR="$HOME/.config/packages"
SCRIPT="$HOME/.config/scripts/install_pkgs.sh"

# Wait for package lists to exist (chezmoi applies them before running this)
if [[ ! -d "$PKGDIR" ]]; then
  echo "Package directory $PKGDIR not found yet, skipping."
  exit 0
fi

if [[ ! -x "$SCRIPT" ]]; then
  echo "Install script $SCRIPT not found yet, skipping."
  exit 0
fi

LISTS=("$PKGDIR/core.txt" "$PKGDIR/dev.txt" "$PKGDIR/apps.txt")

{{ if eq .profile "desktop" -}}
LISTS+=("$PKGDIR/desktop.txt" "$PKGDIR/gaming.txt")
{{ end -}}
{{ if or (eq .purpose "work") (eq .purpose "both") -}}
LISTS+=("$PKGDIR/work.txt")
{{ end -}}

echo "Installing packages for profile={{ .profile }} purpose={{ .purpose }}"
echo "Lists: ${LISTS[*]}"
echo ""

"$SCRIPT" "${LISTS[@]}"
